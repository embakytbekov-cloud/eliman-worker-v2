<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Telegram Auth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ✅ TELEGRAM SDK (КРИТИЧНО) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase.js"></script>

  <style>
    body {
      background:#000;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      height:100vh;
      font-family:system-ui;
    }
  </style>
</head>
<body>

  <div>Authorizing…</div>

<script>
(async () => {

  // 1️⃣ Telegram Mini App check
  if (!window.Telegram || !Telegram.WebApp) {
    alert("Open this app inside Telegram");
    return;
  }

  Telegram.WebApp.ready();

  const user = Telegram.WebApp.initDataUnsafe?.user;

  if (!user || !user.id) {
    alert("Telegram user not found");
    return;
  }

  const telegram_id = String(user.id);

  // 2️⃣ SAVE telegram_id (КЛЮЧЕВО)
  localStorage.setItem("telegram_id", telegram_id);
  console.log("Telegram ID saved:", telegram_id);

  // 3️⃣ CHECK WORKER IN DB
  const { data: worker, error } = await window.db
    .from("workers")
    .select("id")
    .eq("telegram_id", telegram_id)
    .single();

  if (error) console.log("Worker check error:", error);

  // 4️⃣ REDIRECT
  if (worker) {
    window.location.href = "orders.html";
  } else {
    window.location.href = "registration.html";
  }

})();
</script>

</body>
</html>